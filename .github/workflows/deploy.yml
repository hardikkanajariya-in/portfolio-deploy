name: Deploy Demo to Vercel

on:
  repository_dispatch:
    types: [deploy]

  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy from private repo"
        required: true
        default: "develop"
        type: string
      fresh_database:
        description: "Reset database and run seeders"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Determine parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            BRANCH="${{ github.event.client_payload.branch }}"
            FRESH_DB="true"
          else
            BRANCH="${{ github.event.inputs.branch }}"
            FRESH_DB="${{ github.event.inputs.fresh_database }}"
          fi

          BRANCH="${BRANCH:-develop}"
          FRESH_DB="${FRESH_DB:-true}"

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "fresh_database=${FRESH_DB}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Demo deploy â€” branch: ${BRANCH}, fresh_db: ${FRESH_DB}"

      - name: Clone private repository
        run: |
          git clone --depth 1 --branch ${{ steps.params.outputs.branch }} \
            https://x-access-token:${{ secrets.PRIVATE_REPO_PAT }}@github.com/hardikkanajariya-in/portfolio.git app
        env:
          GIT_TERMINAL_PROMPT: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: app/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./app
        run: npm install

      - name: Create .env
        working-directory: ./app
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CRON_SECRET=${{ secrets.CRON_SECRET }}" >> .env
          echo "DEMO_MODE=true" >> .env

      - name: Generate Prisma Client
        working-directory: ./app
        run: npx prisma generate

      - name: Reset Database & Seed
        if: steps.params.outputs.fresh_database == 'true'
        working-directory: ./app
        run: |
          echo "ðŸ—‘ï¸ Resetting demo database..."
          npx prisma migrate reset --force
          echo "ðŸŒ± Seeding demo data..."
          npx tsx prisma/seeders/index.ts
          echo "âœ… Database reset and seeded"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DEMO_MODE: "true"

      - name: Run Migrations Only
        if: steps.params.outputs.fresh_database != 'true'
        working-directory: ./app
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Pull Vercel Environment
        working-directory: ./app
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        working-directory: ./app
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          DEMO_MODE: "true"

      - name: Deploy to Vercel
        id: deploy
        working-directory: ./app
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ðŸš€ Demo deployed to: ${URL}"

      - name: Deployment Summary
        run: |
          echo "## Demo Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.params.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Fresh DB** | \`${{ steps.params.outputs.fresh_database }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Success |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf app
