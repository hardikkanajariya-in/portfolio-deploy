name: Reset Demo Database

on:
  schedule:
    - cron: "0 */8 * * *"

  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to use from private repo"
        required: true
        default: "develop"
        type: string
      seed_only:
        description: "Only reset DB + seed (skip build/deploy)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  reset-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Set parameters
        id: params
        run: |
          BRANCH="${{ github.event.inputs.branch || 'develop' }}"
          SEED_ONLY="${{ github.event.inputs.seed_only || 'false' }}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "seed_only=${SEED_ONLY}" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Demo reset â€” branch: ${BRANCH}, seed_only: ${SEED_ONLY}"

      - name: Clone private repository
        run: |
          git clone --depth 1 --branch ${{ steps.params.outputs.branch }} \
            https://x-access-token:${{ secrets.PRIVATE_REPO_PAT }}@github.com/hardikkanajariya-in/portfolio.git app
        env:
          GIT_TERMINAL_PROMPT: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: app/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./app
        run: npm install

      - name: Create .env
        working-directory: ./app
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CRON_SECRET=${{ secrets.CRON_SECRET }}" >> .env
          echo "DEMO_MODE=true" >> .env

      - name: Generate Prisma Client
        working-directory: ./app
        run: npx prisma generate

      - name: Reset Database & Seed
        working-directory: ./app
        run: |
          echo "ðŸ—‘ï¸ Resetting demo database..."
          npx prisma migrate reset --force
          echo "ðŸŒ± Seeding demo data..."
          npx tsx prisma/seeders/index.ts
          echo "âœ… Database reset and seeded"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DEMO_MODE: "true"

      - name: Install Vercel CLI
        if: steps.params.outputs.seed_only != 'true'
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        if: steps.params.outputs.seed_only != 'true'
        working-directory: ./app
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        if: steps.params.outputs.seed_only != 'true'
        working-directory: ./app
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          DEMO_MODE: "true"

      - name: Deploy to Vercel
        if: steps.params.outputs.seed_only != 'true'
        id: deploy
        working-directory: ./app
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "ðŸš€ Demo deployed to: ${URL}"

      - name: Reset Summary
        run: |
          echo "## Demo Reset Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.params.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **DB Reset** | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **Seeding** | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy** | ${{ steps.params.outputs.seed_only == 'true' && 'â­ï¸ Skipped' || 'âœ… Complete' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url || 'N/A (seed only)' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf app
          echo "## Demo Reset Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.params.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **DB Reset** | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **Seeding** | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy** | ${{ steps.params.outputs.seed_only == 'true' && 'â­ï¸ Skipped' || 'âœ… Complete' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.url || 'N/A (seed only)' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: rm -rf app
